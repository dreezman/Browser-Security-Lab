<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background-color: lightgreen;
      }
      iframe {
        height: 300px;
        width: 400px;
      }

      .left {
        width: 25%;
        overflow: scroll;
        height: 1000px;
      }

      .right {
        width: 75%;
        overflow: scroll;
        height: 1000px;
      }
      /* Create two equal columns that floats next to each other */
      .column {
        float: left;
        width: 50%;
        padding: 33px;
      }

      /* Clear floats after the columns */
      .row:after {
        content: "";
        display: table;
        clear: both;
      }

      /* Responsive layout - makes the two columns stack on top of each other instead of next to each other */
      @media screen and (max-width: 600px) {
        .column {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <h1>CORS Demo Lab</h1>

    <div class="row">
      <div class="column left" style="background-color: lightgreen">
        <script>
          // passed in origin information for iframe1 and iframe2 on parameters.
          // parse out into individual out into protocol,domain,port
          // http://localhost:9081/?iframeurl1=http://localhost:3000/iframes.html&iframeurl2=http://localhost:3001/iframes.html
          const urlParams = new URL(window.location.toLocaleString())
            .searchParams;
          // Specify Origin of IFRAME1
          const iframeurl1 = urlParams.get("iframeurl1");
          var protocol = iframeurl1.replace(
            /(http.*):\/\/(\S+):(\d{0,4})\/.*/,
            "$1"
          );
          var domain = iframeurl1.replace(
            /(http.*):\/\/(\S+):(\d{0,4})\/.*/,
            "$2"
          );
          var port = iframeurl1.replace(
            /(http.*):\/\/(\S+):(\d{0,4})\/.*/,
            "$3"
          );
          const iframe1location = {
            protocol: protocol,
            domain: domain,
            port: port,
          };

          const iframe1origin =
            iframe1location.protocol +
            "://" +
            iframe1location.domain +
            ":" +
            iframe1location.port;

          // Specify Origin of IFRAME2
          const iframeurl2 = urlParams.get("iframeurl2");
          protocol = iframeurl2.replace(
            /(http.*):\/\/(\S+):(\d{0,4})\/.*/,
            "$1"
          );
          domain = iframeurl2.replace(/(http.*):\/\/(\S+):(\d{0,4})\/.*/, "$2");
          port = iframeurl2.replace(/(http.*):\/\/(\S+):(\d{0,4})\/.*/, "$3");
          const iframe2location = {
            protocol: protocol,
            domain: domain,
            port: port,
          };
          const iframe2origin =
            iframe2location.protocol +
            "://" +
            iframe2location.domain +
            ":" +
            iframe2location.port;
        </script>
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Be able to dynamically change CORs headers on web servers              -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <h1>Parent Window</h1>
        <h3 id="ParOrigin"></h3>
        <script>
          document.getElementById("ParOrigin").innerHTML =
            "Origin:" + document.location.origin;
        </script>
        <br />
        Within the parent frame are several internal frames that it will use to
        test cross-origin and same origin restrictions. The Parent window has
        multiple test for various CORS scenarios.
        <ul>
          <li>How cookies are set and used by site not origin</li>
          <li>
            Determine if Internal JS postMessages to cross-origin internal
            frames is impacted by CORS
          </li>
          <li>
            Watch how HTTP GET requests via Fetch and XHL are impacted by CORS
          </li>
          <li>
            Determine if various Form submissions, both Classical and JS based,
            are impacted by CORS
          </li>
          <li>
            Watch how manual JS Queries on Cross origin DOMs are impacted by
            CORS
          </li>
        </ul>
        <hr />
        <h2>CORs Settings Menu</h2>
        Set CORs Headers values on Parent and two iFrames
        <br /><br />
        <form action="/cors-toggle" method="GET">
             Access-Control-Allow-Credentials<br />
          (Send credentials on HTTP Requests):
          <select id="creds" name="creds">
            <option value="NotUsed" selected="selected">
              Not Used(Default)
            </option>
            <option value="Omit">Omit-Never Send</option>
            <option value="Same">SameOrigin - Only send to Same Origin</option>
            <option value="Include">
              Include - Send Credentials Cross Origin
            </option>
          </select>
          <br />
          <br />Access-Control-Allow-Origin<br />
          (Allow CORs HTTP Requests to specific origins):
          <select id="AllowOrigin" name="AllowOrigin">
            <option value="TurnCorsOff">Not Used</option>
            <option value="TurnCorsWildOn" selected="selected">
              Allow All Cross Origin requests(Default)
            </option>
            <option value="TurnCorsRandomOrigOn">
              Allow CORs Requests to weird domain
            </option>
            <option value="TurnCorsSelfOrigOn">
              Allow requests only to Same Origin
            </option>
          </select>
          <br /><br />
          <input type="submit" value="Update Parent CORs headers" /> <br />
          <button
            type="submit"
            formaction="REPLACEWITHIFRAME1ACTION"
            id="iframe1corsupdate"
          >
            Update iframe1 CORs headers
          </button>
          <br />
          <button
            type="submit"
            formaction="REPLACEWITHIFRAME2ACTION"
            id="iframe2corsupdate"
          >
            Update iframe2 CORs headers
          </button>
        </form>

        <script>
          // update CORS origin head update buttons so that we can send
          // corsssettings message to the right iframe origin
          crossOriginUrl = iframe1origin + "/cors-toggle";
          (iframe = document.getElementById("iframe1corsupdate")),
            (iframe.formAction = crossOriginUrl);
          crossOriginUrl = iframe2origin + "/cors-toggle";
          (iframe = document.getElementById("iframe2corsupdate")),
            (iframe.formAction = crossOriginUrl);
        </script>

        <hr />
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                        Setup Cookie  Buttons - Get various cookies sent back in response     -->
        <!--             Test both Same origin and Cross Origin                                           -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <hr />
        <h2>Cooking Testing</h2>
        This test will ask for the Parent web server and if Iframe1 web server
        to return several different cookies. Clear the cookies in your browser
        and compare the network traffic to what you see being returned into
        cookie storage.
        <br />
        <br />

        <button type="button" id="getvariouscookiessameorigin">
          Have Same Origin HTTP server response with various cookies
        </button>
        <div id="sameorigincookieresponse"></div>
        <button type="button" id="getvariouscookiescrossorigin">
          Have Cross Origin HTTP server response with various cookies</button
        >:
        <div id="crossorigincookieresponse"></div>
        <script>
          let cookiecount = 1;
          // Put listeners for the click on the button
          document
            .getElementById("getvariouscookiessameorigin")
            .addEventListener("click", cookieclickHandler, false);
          document.getElementById("getvariouscookiessameorigin").myParam =
            document.location.origin;
          // put listener on cross origin
          document
            .getElementById("getvariouscookiescrossorigin")
            .addEventListener("click", cookieclickHandler, false);
          document.getElementById("getvariouscookiescrossorigin").myParam =
            iframe1origin;
          // execute when cookie button is clicked
          async function cookieclickHandler(e) {
            try {
              const response = await fetch(
                e.srcElement.myParam + "/get-cookies",
                {
                  method: "GET",
                }
              );

              const data = await response.json();
              console.log(data);
              buttonname = e.srcElement.id;
              document.getElementById(buttonname).innerHTML =
                "Get Cookie from Origin:  " +
                response.url +
                " " +
                data.text +
                ":" +
                cookiecount;
              cookiecount += 1;
            } catch (error) {
              console.error(
                "An error occurred retrieving cookie:",
                error.message
              );
            }
          }
        </script>
        <hr />
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Send Internal Post Messages between Parent and Iframes                 -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <h2>JS Post Message Test</h2>
        This test will send an internal JS post message IPC request to both the
        Parent web server and the sub-iframe1 webserver
        <br />
        <br />
        <button type="button" id="sendtochild1">
          Send Message to iframe 1 with JS postMessage</button
        ><br />
        <button type="button" id="sendtochild2">
          Send Message to iframe 2 with JS postMessage</button
        ><br />
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Response HTML element to fill in repsonse from Child iframe            -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <br />
        <div id="responseiframe">
          Post Message Response from either child iframe:
        </div>
        <script>
          // ------------------------------------------------------------------------------------
          // -------------------- Add event listeners on iframes to send msgs via button click to iframes
          // ------------------------------------------------------------------------------------
          function clickHandler(e) {
            console.log("i am postmessagin");
            // find the right iframe in "myParam" to send postMessage to
            document
              .getElementById(e.currentTarget.myParam)
              .contentWindow.postMessage("Parent sending to iframe: ", "*"); // notice, let browser choose origin forces forcing it!!!
          }
          document
            .getElementById("sendtochild1")
            .addEventListener("click", clickHandler, false);
          document.getElementById("sendtochild1").myParam = "iframe1"; //click handler variable to send message to iframe1
          document
            .getElementById("sendtochild2")
            .addEventListener("click", clickHandler, false);
          document.getElementById("sendtochild2").myParam = "iframe2"; //click handler variable to send message to iframe1
        </script>

        <script>
          // ------------------------------------------------------------------------------------
          // -------------------- Event listeners to receive message from iframes
          // ------------------------------------------------------------------------------------
          let count = 1;
          var messageEventHandler = function (event) {
            // check that the origin is one we want.
            if (event.data != undefined && typeof event.data == "string") {
              console.log("parent window receving:  " + event.data);
              document.getElementById("responseiframe").innerHTML =
                "Post Message Response from either child iframe:  " +
                event.data +
                count;
              count += 1;
            }
          };
          window.addEventListener("message", messageEventHandler, false);
        </script>
        <br />

        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                        Setup  Buttons to send HTTP request to backend for secret data        -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <hr />
        <h2>HTML Requests Testing</h2>
        This test will send POST requests to the Parent and SubIframe1 web
        server to retrieve secret data. See if you can read secret data from the
        various JS environments.
        <br />
        <br />
        <button type="button" id="getsecretfromsameorigin">
          Get Secret from Same Origin(Parent) with HTTP Request:</button
        >:
        <div id="sopsecretresponse"></div>
        <button type="button" id="getsecretfromcrossorigin">
          Get Secret from Cross Origin(Iframe1) with HTTP Request:</button
        >:
        <div id="corsecretresponse"></div>
        <br />
        <div id="secretresponse"></div>
        <br />
        <script>
          document
            .getElementById("getsecretfromsameorigin")
            .addEventListener("click", secretsclickHandler, false);
          document.getElementById("getsecretfromsameorigin").myParam =
            document.location.origin;
          document
            .getElementById("getsecretfromcrossorigin")
            .addEventListener("click", secretsclickHandler, false);
          document.getElementById("getsecretfromcrossorigin").myParam =
            iframe1origin;

          let secretcount = 1;
          async function secretsclickHandler(e) {
            try {
              const response = await fetch(
                e.currentTarget.myParam + "/get-json",
                {
                  method: "POST",
                }
              );

              const data = await response.json();
              console.log(data);
              document.getElementById("sopsecretresponse").innerHTML =
                "Get Secret from Same Origin:  " +
                data.text +
                ":" +
                secretcount;
              secretcount += 1;
            } catch (error) {
              console.error("An error occurred:", error.message);
            }
          }
        </script>

        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Setup login forms to store passwords in local storage                                                   -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->

        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Setup Various Classic Form Submits                                    -->
        <!--                                                                                             -->
        <!-- --------------------------------------------------------------------------------------------  -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <hr />
        <h2>Form Submition Testing</h2>

        This test will create two different kinds of forms.
        <ul>
          <li>Classic just submit and do not see response</li>
          <li>
            A form with a JS listner on it to send a GET request to backend
          </li>
        </ul>
        Lets see if they all work the same way with CORS as we do SOP and CORs
        requests
        <br /><br />
        <h3>Classic Same Origin Form Post Submit - Provide Email Info</h3>
        <form
          id="sameoriginclassicloginForm"
          action="/classic-form-submit"
          method="post"
        >
          <label for="fname">Email Address:</label>
          <input
            type="text"
            id="fname"
            name="fname"
            value="someone@somewhere.com"
          />
          <input type="submit" value="Submit" />
          <br />
        </form>

        <h3>Classic Cross Origin Form Post Submit - Provide Email Info</h3>
        <form id="crossoriginclassicloginForm" action="REPLACE" method="post">
          <label for="fname2">Email Address:</label>
          <input
            type="text"
            id="fname2"
            name="fname2"
            value="someone@somewhere.com"
          />
          <input type="submit" value="Submit" />
          <br />
        </form>

        <script>
          // when submit cross origin form, send it to iframe1 webserver
          // replace the action element
          let crossOriginUrl = iframe1origin + "/classic-form-submit";
          (form_parent = document.getElementById(
            "crossoriginclassicloginForm"
          )),
            (form_parent.action = crossOriginUrl);
        </script>

        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!--                       Setup login form for SSL and CrossOrigin Logins                        -->
        <!-- -------------------------------------------------------------------------------------------- -->
        <!-- -------------------------------------------------------------------------------------------- -->

        <h3>JS Fetch based Login Form</h3>
        <form id="loginForm">
          <label for="username">Username:</label>
          <input
            type="text"
            id="username"
            name="username"
            value="admin"
            required
          /><br />
          <label for="password">Password:</label>
          <input
            type="password"
            id="password"
            name="password"
            value="password"
            required
          /><br />
          <input
            type="submit"
            value="non-SSL Parent frame Login"
            id="sopsubmit"
          />
          <input
            type="submit"
            value="SSL Parent frame   Login"
            id="sopsslsubmit"
          />
          <input type="submit" value="non-SSL iframe1 Login" id="corssubmit" />
          <input
            type="submit"
            value="SSL iframe1 Login"
            id="crossorigsslsubmit"
          />
        </form>

        <script>
          document
            .getElementById("loginForm")
            .addEventListener("submit", loginhandler, false);
          document.getElementById("loginForm").myParam =
            document.location.origin;

          async function loginhandler(event) {
            event.preventDefault();

            const username = document.getElementById("username").value;
            const password = document.getElementById("password").value;
            const whichbutton = event.submitter.id;
            if (whichbutton == "sopsubmit") {
              target = document.location.origin + "/login";
            } else if (whichbutton == "sopsslsubmit") {
              // send to HTTPS port of same origin, not cross origin
              target =
                "https://" +
                document.location.hostname +
                ":" +
                (Number(document.location.port) + 300).toString() +
                "/login";
            } else if (whichbutton == "crossorigsslsubmit") {
              // send to HTTPS port which is 300 higher
              target =
                "https://" +
                iframe1location.domain +
                ":" +
                (Number(iframe1location.port) + 300).toString() +
                "/login";
            } else {
              // cross origin target, iframe1 web server
              target = iframe1origin + "/login";
            }

            // actual reqeust
            try {
              const response = await fetch(target, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({ username, password }),
              });

              const data = await response.json();
              console.log(data);
              window.localStorage.setItem(
                "JSCreatedToken_" + document.location.port,
                data.token
              );
              window.document.cookie =
                "JSCreatedToken_" + document.location.port + "=" + data.token;
            } catch (error) {
              console.error("An error occurred:", error.message);
            }
          }
        </script>

        <hr />
      </div>
      <div class="column right" style="background-color: #bbb">
        <div class="row">
          <div class="column">
            <h3>Non-Origin Iframe 1:</h3>
            <div id="iframe1urlparm"></div>
            <br />
            <iframe
              style="border: solid black; background-color: lightblue"
              id="iframe1"
            >
            </iframe>
            <script>
              document.getElementById("iframe1").src = iframeurl1; // load the HTML for this frame
              document.getElementById("iframe1urlparm").innerHTML =
                "Origin:" + document.getElementById("iframe1").src;
            </script>
          </div>

          <div class="column">
            <h3>Non-Origin Iframe 2:</h3>
            <div id="iframe2urlparm"></div>
            <iframe
              style="
                border: solid black;
                background-color: lightgoldenrodyellow;
              "
              id="iframe2"
            >
            </iframe>
            <script>
              document.getElementById("iframe2").src = iframeurl2; // load the HTML for this frame
              document.getElementById("iframe2urlparm").innerHTML =
                "Origin:" + document.getElementById("iframe2").src;
            </script>
          </div>
          <div class="column">
            <h3>Same-Origin Iframe :</h3>
            <div id="sameoriginframeurl"></div>
            <iframe
              style="
                border: 10 solid black;
                background-color: rgb(201, 172, 207);
              "
              id="sameoriginframe"
            >
            </iframe>
            <script>
              document.getElementById("sameoriginframe").src =
                window.location.origin + "/iframes.html"; // load frame from same origin
              document.getElementById("sameoriginframeurl").innerHTML =
                "Origin:" + document.getElementById("sameoriginframe").src;
            </script>
          </div>

          <div class="column">
            <h3>Simple Non Origin Frame:</h3>
            <div id="simplenonoriginframeurl"></div>
            <iframe
              src="https://www.w3.org/wiki/CORS"
              id="simplenonoriginframe"
            ></iframe>
            <script>
              document.getElementById("simplenonoriginframeurl").innerHTML =
                "Origin:" + document.getElementById("simplenonoriginframe").src;
            </script>
          </div>
          <div class="column">
            <h3>Complex Non Origin Frame</h3>
            <div id="complexnonoriginframeurl"></div>
            <iframe
              src="https://www.google.com"
              id="complexnonoriginframe"
            ></iframe>
            <script>
              document.getElementById("complexnonoriginframeurl").innerHTML =
                "Origin:" +
                document.getElementById("complexnonoriginframe").src;
            </script>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
