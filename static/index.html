
<!DOCTYPE html>
<html>
<head>
    <title> CORS  Demo Lab</title>
</head><h2>CORS  Demo Lab</h2>

<body style="border: 10 solid black; width:100%; height: 200px; overflow: auto; background-color: lightgreen;">
  <script>  
    // get origin parameters of two sub iframe web servers, will use later
    const urlParams = new URL(window.location.toLocaleString()).searchParams;  
    var iframeurl1 = urlParams.get('iframeurl1')
    var iframeurl2 = urlParams.get('iframeurl2')
    var iframe1origin= iframeurl1.replace(/(http.*:\d{1,4}.*)(\/.*)/,"$1");
    var iframe2origin= iframeurl2.replace(/(http.*:\d{1,4}.*)(\/.*)/,"$1");
  </script>
<!-- -------------------------------------------------------------------------------------------- -->
<!--                       Setup  Buttons to send msg to iframs                                   -->
<!-- -------------------------------------------------------------------------------------------- -->
<hr>
<h2>CORs Settings Menu</h2>
<form action="/cors-toggle" method="GET" target="_blank">
    <input type="radio" id="corsoff" name="corssettings" value="TurnCorsOff">
    <label for="corsoff">Turn CORs Headers Off</label><br>
    <input type="radio" id="corwildon" name="corssettings" value="TurnCorsWildOn">
    <label for="corswildon">Turn CORs Wildcard ON</label><br>
    <input type="radio" id="randon" name="corssettings" value="TurnCorsRandomOrigOn">
    <label for="corsrandon">Turn CORs Random Origin ON</label><br>
    <input type="radio"name="corsparenon" value="TurnCorsParenOrigOn">
    <label for="corsparenon">Turn CORs Random Origin ON</label><br>
    <input type="submit" value="Submit">
  </form>



<h1> Parent Window </h1>
Within the parent frame are several internal frames that it will use to test cross-origin and 
same origin restrictions. The Parent window has multiple test for various CORS scenarios. 
<ul>
  <li> Internal JS postMessages to cross-origin itnernal frames </li>
  <li> Various Form submissions</li>
  <li> HTTP GET requests via Fetch and XHL</li>
  <li> Cross origin DOM queries</li>
<h2>JS Post Message Test </h2>
<button type="button" id="sendtochild1" > Send Message to iframe 1 with JS postMessage </button><br>
<button type="button" id="sendtochild2" > Send Message to iframe 2 with JS postMessage </button><br>
<!-- -------------------------------------------------------------------------------------------- -->
<!--                       Response HTML element to fill in repsonse from Child iframe            -->
<!-- -------------------------------------------------------------------------------------------- -->
<br>
<div id="responseiframe">Post Message Response from either child iframe: </div>
<script>


  // ------------------------------------------------------------------------------------
  // -------------------- Add event listeners on iframes to send msgs via button click to iframes
  // ------------------------------------------------------------------------------------
  function clickHandler (e) {
      console.log("i am postmessagin");
      // find the right iframe in "myParam" to send postMessage to
      document.getElementById(e.currentTarget.myParam).contentWindow.postMessage('Parent sending to iframe: ',
      '*'); // notice, let browser choose origin forces forcing it!!!
      }
  document.getElementById("sendtochild1").addEventListener('click',clickHandler,false);
  document.getElementById("sendtochild1").myParam = "iframe1"  //click handler variable to send message to iframe1
  document.getElementById("sendtochild2").addEventListener('click',clickHandler,false);
  document.getElementById("sendtochild2").myParam = "iframe2"  //click handler variable to send message to iframe1
  </script>




<script>
  // ------------------------------------------------------------------------------------
  // -------------------- Event listeners to receive message from iframes
  // ------------------------------------------------------------------------------------
  let count=1
  var messageEventHandler = function(event){
  // check that the origin is one we want.
      if(
              event.data != undefined && (typeof event.data) == 'string'
          ) 
          {
          console.log('parent window receving:  '+ event.data)
          document.getElementById("responseiframe").innerHTML = "Post Message Response from either child iframe:  "+ event.data  + count;
          count += 1
          }            
      }           
  window.addEventListener('message', messageEventHandler,false);


</script>

    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!--                        Setup  Buttons to send HTTP request to backend for secret data        -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <hr>
    <h2>HTML Requests Testing </h2>
<br>
<button type="button" id="getsecretfromsameorigin" >  Get Secret from Same Origin with HTTP Request:   </button>: <div id="sopsecretresponse"></div>
<button type="button" id="getsecretfromcrossorigin" > Get Secret from Cross Origin with HTTP Request:  </button>: <div id="corsecretresponse"></div><br>
<div id="secretresponse"></div>
<br>
<script>

    document.getElementById("getsecretfromsameorigin").addEventListener('click',secretsclickHandler,false);
    document.getElementById("getsecretfromsameorigin").myParam = document.location.origin
    document.getElementById("getsecretfromcrossorigin").addEventListener('click',secretsclickHandler,false);
    document.getElementById("getsecretfromcrossorigin").myParam = iframe1origin

    let  secretcount=1;
   async function secretsclickHandler (e) {
    try {
        const response = await fetch(e.currentTarget.myParam + '/get-json', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ username, password })
        });
    
        const data = await response.json();
        console.log(data);
        document.getElementById("sopsecretresponse").innerHTML = "Get Secret from Same Origin:  "+ data.text + ':' +secretcount;
        secretcount +=1

      } catch (error) {
      console.error('An error occurred:', error.message);
      }
      }



  </script>

    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!--                       Setup login forms to store passwords in local storage                                                   -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->

    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!--                       Setup Classic Form Submit to                                           -->
    <!--      login form to store passwords in local storage                                          -->
   <!-- --------------------------------------------------------------------------------------------  -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <hr>
    <h2>Form Submition Testing</h2>
    <h3>Classic Same Origin Form Post Submit - Provide Email Info</h3>
    <form id="sameoriginclassicloginForm" action="/classic-form-submit" method="post">
      <label for="fname">Email Address:</label>
      <input type="text" id="fname" name="fname" value="someone@somewhere.com">
      <input type="submit" value="Submit">      
      <br>
    </form>


    <h3>Classic Cross Origin Form Post Submit - Provide Email Info</h3>
    <form id="crossoriginclassicloginForm" action="REPLACE" method="post">
      <label for="fname2">Email Address:</label>
      <input type="text" id="fname2" name="fname2" value="someone@somewhere.com">
      <input type="submit" value="Submit">      
      <br>
    </form>

    <script>
      // when submit cross origin form, send it to iframe1 webserver
      // replace the action element
      let crossOriginUrl= iframe1origin + "/classic-form-submit";
          form_parent = document.getElementById('crossoriginclassicloginForm'),
          form_parent.action=crossOriginUrl
    </script>

    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!--                       Setup login form to store passwords in local storage                                                   -->
    <!-- -------------------------------------------------------------------------------------------- -->
    <!-- -------------------------------------------------------------------------------------------- -->

   <h3> JS Fetch based Login Form </h3>
    <form id="loginForm">
      <label for="username">Username:</label>
      <input type="text" id="username" name="username" value="admin" required><br>
      <label for="password">Password:</label>
      <input type="password" id="password" name="password" value="password" required><br>
      <input type="submit" value="non-SSL Same Origin Login" id="sopsubmit">
      <input type="submit" value="SSL Cross Origin Login" id="sslsubmit">
      <input type="submit" value="Cross Origin Login" id="corssubmit">
    </form>


    <script>
    document.getElementById('loginForm').addEventListener('submit', loginhandler,false);
    document.getElementById('loginForm').myParam = document.location.origin
    
    
    
    
    async function loginhandler  (event) {
        event.preventDefault();
      
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const whichbutton = event.submitter.id
        if (whichbutton=='sopsubmit') {
          target=document.location.origin +'/login'
        }
        else if (whichbutton=='sslsubmit')  { // send to HTTPS port which is 300 higher
          target='https://' + document.location.hostname + ':' + (Number(document.location.port)+300).toString() +'/login'
        } else { // cross origin target, iframe1 web server
          target=iframe1origin +'/login'
        }

        // actual reqeust
        try {
          const response = await fetch(target, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username, password })
          });
      
          const data = await response.json();
          console.log(data);
          window.localStorage.setItem("AccessToken"+ document.location.port,data.token)
          window.document.cookie=data.token
        } catch (error) {
        console.error('An error occurred:', error.message);
        }
      };
    </script>

<hr>
<!-- -------------------------------------------------------------------------------------------- -->
<!-- -------------------------------------------------------------------------------------------- -->
<!--                       Set up 2 iFrames                                                       -->
<!-- go run static-web.go TLD 8081 & go run static-web.go sub1 3000 & go run static-web.go sub2 3001 & -->
<!-- -------------------------------------------------------------------------------------------- -->
<!-- -------------------------------------------------------------------------------------------- -->
<h3> Non-Origin Iframe 1: </h3> <div id="iframe1urlparm"></div><br>
<iframe style="border: 10 solid black; width:100%; height: 250px; overflow: auto; background-color: lightblue;" id="iframe1">
</iframe>
<script>
  document.getElementById('iframe1').src=iframeurl1; // load the HTML for this frame
  document.getElementById('iframe1urlparm').innerHTML = "Origin:" + document.getElementById('iframe1').src
</script>




<h3> Non-Origin Iframe 2: </h3> <div id="iframe2urlparm"></div>
<iframe style=" border: 10 solid black; width:100%; height: 250px; overflow: auto; background-color: lightgoldenrodyellow;"  id="iframe2">
</iframe>
<script>
  document.getElementById('iframe2').src=iframeurl2;// load the HTML for this frame
  document.getElementById('iframe2urlparm').innerHTML = "Origin:" + document.getElementById('iframe2').src
</script>



<h3> Same-Origin Iframe : </h3> <div id="sameoriginframeurl"></div>
<iframe style=" border: 10 solid black; width:100%; height: 250px; overflow: auto; background-color: rgb(201, 172, 207);"  id="sameoriginframe">
</iframe>
<script>
  document.getElementById('sameoriginframe').src=window.location.origin + "/iframes.html"; // load frame from same origin
  document.getElementById('sameoriginframeurl').innerHTML = "Origin:" + document.getElementById('sameoriginframe').src
</script>


<h3> Simple Non Origin Frame:  </h3><div id="simplenonoriginframeurl"></div>
<iframe src="https://www.w3.org/wiki/CORS" id="simplenonoriginframe"></iframe>
<script>
  document.getElementById('simplenonoriginframeurl').innerHTML = "Origin:" + document.getElementById('simplenonoriginframe').src
</script>


<h3> Complex Non Origin Frame </h3> <div id="complexnonoriginframeurl"></div>
<iframe src="https://www.google.com"     id="complexnonoriginframe"></iframe>
<script>
  document.getElementById('complexnonoriginframeurl').innerHTML = "Origin:" + document.getElementById('complexnonoriginframe').src
</script>




</body>
<!-- -------------------------------------------------------------------------------------------- -->
<!-- -------------------------------------------------------------------------------------------- -->
<!--                       Setup  Parent    Window                                                -->
<!-- -------------------------------------------------------------------------------------------- -->
<!-- -------------------------------------------------------------------------------------------- -->

</html>

